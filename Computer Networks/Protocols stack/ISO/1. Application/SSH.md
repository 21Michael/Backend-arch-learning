# SSH

**SSH (от англ. “Secure Shell”)** — это протокол удаленного администрирования,
разработанный для осуществления удаленного управления операционными системами и
туннелирования TCP-соединения. Использование этого протокола допускает использование
разных алгоритмов шифрования, что позволяет безопасно работать практически в любой
незащищенной среде: работать с ПК через командную оболочку, передавать по шифрованному
каналу любой тип данных (например, видео- и аудиофайлы).

### Протокол SSH включает в себя 3 уровня:   
  **1) Протокол транспортного уровня** — используется для аутентификации сервера при
  запуске системы и для обеспечения конфиденциальности и целостности данных.
  Реализация технологии происходит поверх соединения TCP/IP;  
  **2) Протокол аутентификации** — предназначен для обеспечения аутентификации
  пользователя для сервера при его первичном запросе;  

  **Способы аутентификации:**
  - **Пароль / логин;**  
    Это самый простой способ. Хостер предоставляет вам IP-адрес, логин и пароль.
    Этого достаточно для того, чтобы установить соединение с удаленным сервером.
  - **Ключ (более безопасный);**  
    В отличие от пароля который можно подобрать, для авторизации по ключу используется
    **АССИМЕСТРИЧЕСКИЙ** способ шифрования (приватный и публичный ключ);
    
  **3) Протокол соединения** — используется для обеспечения работы отдельных логических
  каналов поверх единого SSH-соединения.  
  

## Подключение по ключу (ассиметрическое шифрование) SSH:

### 1) Транспортный уровень:
  1. **Установка TCP-соединения**  
     На этом этапе происходит сетевое подключение клиента к серверу на TCP-порт, 
     указанный в опции Port (по умолчанию: 22) в файле конфигурации сервера 
     /etc/ssh/sshd_config.
     
     ![link](https://ru.hostings.info/upload/images/2020/12/906d9b006b71b2c6e1d45ad46f86713b.jpg)
  
  2. **Открытие защищенного канала:**  
     
     2.1 **Обмен идентификационными данными:**  
     После установки TCP-соединения, клиент и сервер (далее по тексту – стороны)
     обмениваются версиями SSH-протокола и другими вспомогательными данными, 
     необходимыми для выяснения совместимости протоколов и для выбора алгоритмов работы.
     
     2.2 **Выбор алгоритмов: обмена ключами, шифрования, сжатия и т.п.**  
     При работе SSH используется довольно много алгоритмов, одни из них используются 
     для шифрования, вторые для обмена ключами, третьи для сжатия передаваемых данных 
     и т.п. На этом шаге стороны отсылают друг другу списки поддерживаемых алгоритмов, 
     наибольший приоритет имеют алгоритмы в начале каждого списка. Затем сравнивают
     алгоритмы в полученных списках с алгоритмами, имеющимися в системе, и выбирают 
     первый совпавший в каждом списке.

     2.3 **Получение сессионного ключа шифрования (ключа для симметрического шифрования 
     данных в соединении):**  
      1. Сервер отсылает клиенту свой ключ (DSA, RSA или т.п. согласно договорённости
         между сторонами, произведёнными в п.2.2).
      2. Если клиент производит соединение с данным сервером впервые (о чем говорит 
         отсутствие записи в файле /home/username/.ssh/known_hosts у клиента), то 
         пользователю будет задан вопрос о доверии ключу сервера. Если же соединение 
         с данным сервером уже устанавливалось ранее, то клиент сравнивает присланный 
         ключ с ключом, записанным в /home/username/.ssh/known_hosts. Если ключи не
         совпадают, то пользователь получит предупреждение о возможной попытке взлома.
      3. Как только клиент определился с доверием к ключу сервера, с помощью одной из
         реализаций (версия определяется в п.2.2) алгоритма Диффи-Хеллмана клиент и 
         сервер генерируют сеансовый ключ, который будет использоваться для симметричного
         шифрования канала.
         
         
![link](https://drive.google.com/uc?id=13L3tdYSn3_ts-zRXFXVJ5s4ujRybnwoo)
  
### 2) **Аутентификация клиента:**  
 Только теперь, когда клиент и сервер установили канал для зашифрованной передачи данных, 
 они могут произвести аутентификацию по паролю или ключам.

  **В общих чертах, аутентификация посредством ключей происходит следующим образом:**

  - Клиент отсылает серверу имя пользователя (username) и свой публичный ключ.
  - Сервер проверяет в файле /home/username/.ssh/authorized_keys наличие присланного клиентом
    открытого ключа. Если открытый ключ найден, то сервер генерирует случайное число и шифрует 
    его открытым ключом клиента, после чего результат отправляется клиенту.
  - Клиент расшифровывает сообщение своим приватным ключом и отправляет результат серверу.
  - Сервер проверяет полученный результат на совпадение с тем числом, которое он изначально 
    зашифровал открытым ключом клиента, и в случае совпадения считает аутентификацию успешной.

![link](https://drive.google.com/uc?id=1s6IaD3BFtz4ZrB_99XMp0jq63oPGaeil)

### 3) **Установление соединения:**  
После проведения всех вышеперечисленных процедур, пользователь получает возможность передавать 
команды серверу или копировать файлы.

На этом уровне обеспечивается: мультиплицирование каналов (возможность работы множества каналов к 
одному серверу за счет объединения их в один канал), туннелирование и т.п.